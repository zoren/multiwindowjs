<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Home</title>
  </head>
  <body>
    <h1>Multi window broadcast channel demo</h1>
    <p id="iam"></p>
    <div id="sessions">
      <h2>Sessions</h2>
      <ul id="sessionList"></ul>
    </div>
    <script>
      const updateSession = ({ sessionId, screenLeft, screenTop }) => {
        const li = document.getElementById(sessionId);
        const [, l, t] = li.children;
        l.textContent = screenLeft;
        t.textContent = screenTop;
      };
      const sessionList = document.getElementById("sessionList");
      const addSession = (params) => {
        const { sessionId, screenLeft, screenTop } = params;
        let li = document.getElementById(sessionId);
        if (!li) {
          li = document.createElement("li");
          li.id = sessionId;
          const idSpan = document.createElement("span");
          idSpan.textContent = sessionId;
          li.append(
            idSpan,
            ": ",
            document.createElement("span"),
            ",",
            document.createElement("span")
          );
          const insertOrdered = () => {
            for (const child of sessionList.children) {
              if (li.id < child.id) {
                sessionList.insertBefore(li, child);
                return;
              }
            }
            sessionList.append(li);
          };
          insertOrdered();
        }
        updateSession(params);
        return li;
      };

      const sessionId = Math.random().toString(36).substr(2, 5);

      const sessionObj = { sessionId };

      const myli = addSession(sessionObj);
      myli.style.backgroundColor = "lightgreen";
      iam.textContent = "I am " + sessionId;
      const channel = new BroadcastChannel("example-channel");

      const positionElem = () => {
        const { screenLeft, screenTop } = window;
        sessionObj.screenLeft = screenLeft;
        sessionObj.screenTop = screenTop;
        updateSession(sessionObj);
        channel.postMessage(sessionObj);
        window.requestAnimationFrame(positionElem);
      };

      window.requestAnimationFrame(positionElem);

      window.addEventListener("beforeunload", () => {
        channel.postMessage({ sessionId, message: "leaving" });
        channel.close();
      });

      channel.addEventListener("message", ({ data }) => {
        const { sessionId } = data;
        if (data.message === "leaving") {
          document.getElementById(sessionId).remove();
        } else {
          addSession(data);
        }
      });
    </script>
  </body>
</html>
