<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Home</title>
  </head>
  <body>
    <h1>Multi window broadcast channel demo</h1>
    <div id="sessions">
      <h2>Sessions</h2>
      <ul id="sessionList"></ul>
    </div>
    <script>
      const sessionList = document.getElementById("sessionList");
      const createSessionLi = (sessionId) => {
        const li = document.createElement("li");
        li.id = sessionId;
        const idSpan = document.createElement("span");
        idSpan.textContent = sessionId;
        li.append(
          idSpan,
          ": ",
          document.createElement("span"),
          ",",
          document.createElement("span")
        );
        return li;
      };

      const insertOrdered = (li) => {
        for (const child of sessionList.children) {
          if (li.id < child.id) {
            sessionList.insertBefore(li, child);
            return;
          }
        }
        sessionList.append(li);
      };

      const updateSessionElement = (li, { screenLeft, screenTop }) => {
        const [, l, t] = li.children;
        l.textContent = screenLeft;
        t.textContent = screenTop;
      };

      const sessionId = Math.random().toString(36).substr(2, 5);

      const myli = createSessionLi(sessionId);
      myli.style.backgroundColor = "lightgreen";
      sessionList.append(myli);

      const channel = new BroadcastChannel("position-channel");

      const positionElem = () => {
        updateSessionElement(myli, window);
        const { screenLeft, screenTop } = window;
        channel.postMessage({ sessionId, screenLeft, screenTop});
        window.requestAnimationFrame(positionElem);
      };

      window.requestAnimationFrame(positionElem);

      window.addEventListener("beforeunload", () => {
        channel.postMessage({ sessionId, message: "leaving" });
        channel.close();
      });

      channel.addEventListener("message", ({ data }) => {
        const { sessionId } = data;
        let sessionElement = document.getElementById(sessionId);
        if (data.message === "leaving") {
          if (sessionElement) sessionElement.remove();
        } else {
          if (!sessionElement) {
            sessionElement = createSessionLi(sessionId);
            insertOrdered(sessionElement);
          }
          updateSessionElement(sessionElement, data);
        }
      });
    </script>
  </body>
</html>
